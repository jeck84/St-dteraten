<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Städte-Ratespiel Deutschland</title>
<style>
  html, body {
    margin:0; padding:0; height:100%; font-family: Arial, sans-serif; font-size: 1.1em;
  }
  #map { width: 100%; height: 75vh; position: relative; }
  #info {
    padding: 12px;
    background: #f8f8f8;
    display: flex; flex-wrap: wrap; align-items: center; gap: 12px;
  }
  #cityName { font-weight: bold; font-size: 1.2em; flex:1 1 100%; }
  #score, #highscore, #round { font-weight: bold; margin-right: 12px; }
  button {
    padding: 10px 16px;
    font-size: 1em;
    border-radius: 6px;
    cursor: pointer;
    border:none;
    background: #007bff;
    color: white;
    transition: background-color 0.3s;
  }
  button:disabled {
    background: #aaa;
    cursor: default;
  }
  button:hover:not(:disabled) {
    background: #0056b3;
  }
  #popup {
    position: absolute;
    padding: 10px 14px;
    border-radius: 6px;
    font-weight: bold;
    display: none;
    z-index: 1000;
    pointer-events: none;
    box-shadow: 0 0 8px rgba(0,0,0,0.3);
    background: rgba(255,255,255,0.9);
    color: #000;
  }
  /* Fadenkreuz am Ziel */
  .crosshair {
    width: 24px;
    height: 24px;
    border: 3px solid red;
    border-radius: 50%;
    box-sizing: border-box;
    background: transparent;
    pointer-events: none;
  }
  /* Zusammenfassungs-Popup */
  #summaryPopup {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: #007bff;
    color: white;
    padding: 20px 30px;
    border-radius: 12px;
    font-size: 1.3em;
    font-weight: bold;
    display: none;
    z-index: 2000;
    box-shadow: 0 0 15px rgba(0,0,0,0.5);
    text-align: center;
    max-width: 90vw;
  }
</style>
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"
/>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
</head>
<body>
<div id="info">
  <div id="cityName">Klicke auf die Karte, um die Stadt oder Sehenswürdigkeit zu lokalisieren!</div>
  <div>
    <span id="round">Frage: 0 / 10</span>
    <span id="score">Punkte: 0</span>
    <span id="highscore">Highscore: 0</span>
  </div>
  <div>
    <button id="nextBtn" onclick="nextRound()" disabled>Nächstes Ziel</button>
    <button id="newGameBtn" onclick="newGame()">Neues Spiel</button>
  </div>
</div>
<div id="popup"></div>
<div id="map"></div>
<div id="summaryPopup"></div>

<script>
const MAPTILER_API_KEY = "Ata7fzCIWNX2Y9WUthnN";

const locations = [
  { name: "Berlin", lat: 52.5200, lon: 13.4050 },
  { name: "Hamburg", lat: 53.5511, lon: 9.9937 },
  { name: "München", lat: 48.1351, lon: 11.5820 },
  { name: "Kölner Dom", lat: 50.9413, lon: 6.9583 },
  { name: "Frankfurt am Main", lat: 50.1109, lon: 8.6821 },
  { name: "Dresden", lat: 51.0504, lon: 13.7373 },
  { name: "Schloss Neuschwanstein", lat: 47.5576, lon: 10.7498 },
  { name: "Brandenburger Tor", lat: 52.5163, lon: 13.3777 },
  { name: "Heidelberg", lat: 49.3988, lon: 8.6724 },
  { name: "Leipzig", lat: 51.3397, lon: 12.3731 },
];

let map = L.map("map").setView([51.1657, 10.4515], 6);

const tileLayerLight = L.tileLayer(
  `https://api.maptiler.com/maps/basic-v2/256/{z}/{x}/{y}.png?key=${MAPTILER_API_KEY}`, {
    attribution:
      '&copy; <a href="https://www.maptiler.com/">MapTiler</a> &copy; OpenStreetMap contributors',
    maxZoom: 18,
  }
).addTo(map);

let target = null;
let score = 0;
let highscore = 0;
let round = 0;
let currentLine = null;
let currentMarker = null;
let gameStartTime = null;

const maxRounds = 10;

const cityNameDiv = document.getElementById("cityName");
const roundSpan = document.getElementById("round");
const scoreSpan = document.getElementById("score");
const highscoreSpan = document.getElementById("highscore");
const nextBtn = document.getElementById("nextBtn");
const popup = document.getElementById("popup");
const summaryPopup = document.getElementById("summaryPopup");

function calcPoints(distanceKm) {
  if (distanceKm <= 10) return 100;
  const reduction = Math.floor(distanceKm / 100) * 10;
  return Math.max(0, 100 - reduction);
}

const crosshairIcon = L.divIcon({
  className: "crosshair",
  iconSize: [24, 24],
  iconAnchor: [12, 12],
  popupAnchor: [0, -12],
});

function nextRound() {
  if (round >= maxRounds) {
    return;
  }

  round++;
  roundSpan.textContent = `Frage: ${round} / ${maxRounds}`;
  cityNameDiv.textContent = `Wo befindet sich: ${locations[round - 1].name}?`;
  nextBtn.disabled = true;

  if (currentLine) {
    map.removeLayer(currentLine);
    currentLine = null;
  }
  if (currentMarker) {
    map.removeLayer(currentMarker);
    currentMarker = null;
  }

  target = locations[round - 1];

  if (round === 1) {
    gameStartTime = Date.now();
  }
}

map.on("click", function (e) {
  if (!target || nextBtn.disabled === false) {
    return;
  }

  if (currentLine) {
    map.removeLayer(currentLine);
    currentLine = null;
  }
  if (currentMarker) {
    map.removeLayer(currentMarker);
    currentMarker = null;
  }

  const guessLatLng = e.latlng;
  const targetLatLng = L.latLng(target.lat, target.lon);

  currentLine = L.polyline([guessLatLng, targetLatLng], { color: "blue" }).addTo(map);
  currentMarker = L.marker(targetLatLng, { icon: crosshairIcon }).addTo(map);

  const distance = guessLatLng.distanceTo(targetLatLng) / 1000;
  const points = calcPoints(distance);
  score += points;
  scoreSpan.textContent = `Punkte: ${score}`;

  // Popup neben Linie positionieren, leicht versetzt vom Klickpunkt
  const popupOffset = 20; // Pixel nach rechts und oben
  const containerPoint = map.latLngToContainerPoint(guessLatLng);
  popup.style.left = (containerPoint.x + popupOffset) + "px";
  popup.style.top = (containerPoint.y - popupOffset) + "px";
  popup.textContent = `Entfernung: ${distance.toFixed(1)} km → +${points} Punkte`;
  popup.style.display = "block";

  nextBtn.disabled = false;

  if (round === maxRounds) {
    setTimeout(showSummary, 4000);
  }
});

function showSummary() {
  const totalTimeSec = ((Date.now() - gameStartTime) / 1000).toFixed(1);

  summaryPopup.innerHTML =
    `Spiel beendet!<br>` +
    `Dein Highscore: <b>${Math.max(highscore, score)}</b><br>` +
    `Deine Punktzahl: <b>${score}</b><br>` +
    `Benötigte Gesamtzeit: <b>${totalTimeSec} Sekunden</b>`;

  summaryPopup.style.display = "block";

  if (score > highscore) {
    highscore = score;
    highscoreSpan.textContent = `Highscore: ${highscore}`;
  }

  target = null;
  nextBtn.disabled = true;
  cityNameDiv.textContent = "Spiel beendet!";
}

function newGame() {
  score = 0;
  round = 0;
  cityNameDiv.textContent = "Klicke auf die Karte, um die Stadt oder Sehenswürdigkeit zu lokalisieren!";
  scoreSpan.textContent = "Punkte: 0";
  roundSpan.textContent = `Frage: 0 / ${maxRounds}`;
  summaryPopup.style.display = "none";
  popup.style.display = "none";
  nextBtn.disabled = true;

  if (currentLine) {
    map.removeLayer(currentLine);
    currentLine = null;
  }
  if (currentMarker) {
    map.removeLayer(currentMarker);
    currentMarker = null;
  }

  target = null;

  nextRound();
}

// Spiel direkt starten
newGame();
</script>
</body>
</html>
